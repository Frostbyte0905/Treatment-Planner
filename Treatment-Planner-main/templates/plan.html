{% extends "base.html" %}
{% block content %}
<section class="plan-header">
  <div>
    <h2>Treatment Plan</h2>
    {% if patient_name %}<p><strong>Patient:</strong> {{ patient_name }}</p>{% endif %}
    <p><strong>Insurance maximum:</strong> {{ insurance_max }} {% if max_reached %}<span class="tag">Max reached</span>{% endif %}</p>
  </div>
  <div class="tooth-diagram">
    <figure>
      <img src="{{ url_for('static', filename='teeth.jpg') }}" alt="Tooth number reference" loading="lazy" decoding="async">
      <figcaption>Tooth numbers for reference</figcaption>
    </figure>
  </div>
</section>

<section class="card">
  <div class="table-wrap">
    <table class="plan-table" id="plan-table">
      <thead>
        <tr>
          <th class="editable" data-edit="h0" contenteditable="false">Procedure</th>
          <th class="editable" data-edit="h1" contenteditable="false">Tooth</th>
          <th class="editable" data-edit="h2" contenteditable="false">Reason</th>
          <th class="editable" data-edit="h3" contenteditable="false">Cost</th>
          <th class="editable" data-edit="h4" contenteditable="false">Est. Insurance Coverage*</th>
          <th class="editable" data-edit="h5" contenteditable="false">Est. Patient Responsibility</th>
          <!-- two-line monthly header, no crowding -->
          <th class="editable col-month" data-edit="h6" contenteditable="false">
            Est. Monthly<br>(48 mo @ 15%)**
          </th>
        </tr>
      </thead>

      <tbody>
        {% for r in rows %}
        <tr>
          <td class="editable" data-edit="display_name" data-index="{{ loop.index0 }}" contenteditable="false">{{ r.display_name }}</td>
          <td class="editable" data-edit="tooth"        data-index="{{ loop.index0 }}" contenteditable="false">{{ r.tooth }}</td>
          <td class="editable" data-edit="reason"       data-index="{{ loop.index0 }}" contenteditable="false">{{ r.reason }}</td>
          <td class="editable" data-edit="cost"         data-index="{{ loop.index0 }}" contenteditable="false">{{ r.cost }}</td>
          <td class="editable" data-edit="ins_override" data-index="{{ loop.index0 }}" contenteditable="false">{{ r.insurance_pay }}</td>
          <td class="editable" data-edit="pat_override" data-index="{{ loop.index0 }}" contenteditable="false">{{ r.patient_pay }}</td>
          <td class="editable" data-edit="mon_override" data-index="{{ loop.index0 }}" contenteditable="false">
            {% if not r.monthly_disabled %}{{ r.monthly_est }}{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>

      <tfoot>
        <tr>
          <th colspan="5" class="right">Total paid by insurance*</th>
          <th colspan="2" class="editable" data-edit="total_ins_override" contenteditable="false">{{ insurance_total }}</th>
        </tr>
        <tr>
          <th colspan="5" class="right">Total paid by patient*</th>
          <th colspan="2" class="editable" data-edit="total_pat_override" contenteditable="false">{{ patient_total }}</th>
        </tr>
        <tr>
          <th colspan="5" class="right">Total est. monthly**</th>
          <th colspan="2" class="editable" data-edit="total_mon_override" contenteditable="false">{{ monthly_total }}</th>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="notes">
    <h3>Notes</h3>
    <p class="editable" data-edit="notes" contenteditable="false">{{ notes }}</p>
  </div>

  <div class="disclaimer">
    <p>
      * Est. insurance coverage is based on the percentages entered and remaining plan maximum. Final responsibility may change if benefits, deductibles, waiting periods, or plan limits apply.<br>
      ** Est. monthly payment is for illustration only and may vary based on credit approval, exact interest rate, and lender terms.
    </p>
  </div>

  <div class="print-actions">
    <button class="btn primary" onclick="window.print()">Print</button>
    <a class="btn primary" href="{{ url_for('edit') }}">Return to planning</a>
    <button class="btn primary" id="inline-edit">Edit on page</button>
    <button class="btn primary" id="inline-save" style="display:none;">Save edits</button>
    <a class="btn primary" href="{{ url_for('index') }}">Start a new plan</a>
  </div>
</section>

<script>
(function(){
  const editBtn = document.getElementById('inline-edit');
  const saveBtn = document.getElementById('inline-save');
  const editable = document.querySelectorAll('[data-edit]');

  function setEditing(on){
    editable.forEach(el => {
      el.contentEditable = on ? 'true' : 'false';
      el.classList.toggle('editing', on);
    });
    editBtn.style.display = on ? 'none' : '';
    saveBtn.style.display = on ? '' : 'none';
  }

  if(editBtn){ editBtn.addEventListener('click', () => setEditing(true)); }

  if(saveBtn){
    saveBtn.addEventListener('click', () => {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '{{ url_for("plan_inline") }}';
      const add = (n,v) => { const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v; form.appendChild(i); };

      add('patient_name', document.querySelector('[data-edit="patient_name"]')?.textContent.trim() || '');
      add('insurance_max', (document.querySelector('[data-edit="insurance_max"]')?.textContent || '').replace(/[$,]/g,'').trim() || '0');
      add('notes', document.querySelector('[data-edit="notes"]')?.textContent.trim() || '');

      ['h0','h1','h2','h3','h4','h5','h6'].forEach(h=>{
        add('header_labels[]', document.querySelector(`[data-edit="${h}"]`)?.textContent.trim() || '');
      });

      document.querySelectorAll('#plan-table tbody tr').forEach((row)=>{
        const val = sel => row.querySelector(sel)?.textContent.trim() || '';
        add('display_name[]', val('[data-edit="display_name"]'));
        add('tooth[]',        val('[data-edit="tooth"]'));
        add('reason[]',       val('[data-edit="reason"]'));
        add('cost[]',        (row.querySelector('[data-edit="cost"]')?.textContent || '').replace(/[$,]/g,'').trim() || '0');
        add('ins_override[]', val('[data-edit="ins_override"]'));
        add('pat_override[]', val('[data-edit="pat_override"]'));
        add('mon_override[]', val('[data-edit="mon_override"]'));
      });

      add('total_ins_override', document.querySelector('[data-edit="total_ins_override"]')?.textContent.trim() || '');
      add('total_pat_override', document.querySelector('[data-edit="total_pat_override"]')?.textContent.trim() || '');
      add('total_mon_override', document.querySelector('[data-edit="total_mon_override"]')?.textContent.trim() || '');

      document.body.appendChild(form);
      form.submit();
    });
  }
})();
</script>
{% endblock %}
